---
title: "Raw MS data processing using massprocesser"
author:
- name: Xiaotao Shen (https://www.shenxt.info/)
date: "Created on 2020-04-01 and updated on `r Sys.Date()`"
output:
  html_document:
    df_print: paged
    toc: no
  pdf_document:
    toc: no
vignette: >
  %\VignetteIndexEntry{raw_data_processing}
  %\VignettePackage{massprocesser}
  % \VignetteEngine{knitr::rmarkdown}
  % \usepackage[utf8]{inputenc}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE, echo=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  # fig.width = 7, 
  # fig.height = 5,
  warning = FALSE,
  message = TRUE,
  out.width = "100%"
)
```

***

---

# **Download demo data**

---

Raw data can be downloaded from the Google drive. [Link is here](https://drive.google.com/file/d/15OheYiPbqK7Bq8hdEvP9hdA0ER20P-xm/view?usp=sharing)

---

# **Data preparation**

---

*massprocesser* can used to processed the raw MS data for peak detection and alignment, and generate a peak table for next analysis. 

The MS raw data from Mass Spectrometry should be converted to `mzXML` or `mzML`format and then placed in different folders according to their class, for example `Subject`, `QC`, and `Blank` samples.

![](figures/Screen-Shot-2022-01-14-at-11.52.53-PM.png)

You can convert raw MS data to `mzXML` or `mzML` format using [`ProteoWizard` software](http://proteowizard.sourceforge.net/). And the parameter setting is shown the below figure:

![](figures/Screen-Shot-2022-01-14-at-11.54.24-PM.png)
---

# **Data organization**

---

All the `mzXML` format files should be placed in different folder according to sample type, such as `QC`, `Subject`, `Control`, `Case`, and `Blank`. 

![](figures/Screen-Shot-2022-01-14-at-11.52.53-PM.png)

---

# **Run `process_data()`** function

---

This function is used to peak picking and peak alignment.

```{r,eval=FALSE,warning=FALSE, R.options="", message=FALSE}
library(massprocesser)
library(tidyverse)
library(xcms)
library(MSnbase)
library(mzR)
```

## **Data processing**

Next, we use the `process_data()` function for peak detection and alignment.

We first do the positive mode.

```{r,eval=TRUE,warning=FALSE, message=FALSE,R.options="",cache=TRUE, message=FALSE}
massprocesser::process_data(
  path = "massprocesser_demo_data/POS/",
  polarity = "positive",
  ppm = 15,
  peakwidth = c(10, 60),
  snthresh = 5,
  noise = 500,
  threads = 6,
  output_tic = TRUE,
  output_bpc = TRUE,
  output_rt_correction_plot = TRUE,
  min_fraction = 0.5,
  fill_peaks = FALSE,
  group_for_figure = "QC"
)
```

Some important arguments:

* `ppm`: Peak detection ppm. See the `xcms` package.

* `peakwidth`: Peak width. It is dependent on your column and LC system. See the `xcms` package.

* `snthresh`: Signal to noise threshold. See the `xcms` package.

* `noise`: Noise cutoff. See the `xcms` package.

* `threads`: The core number for performing.

* `output_tic`, `output_bpc`, and `group_for_figure`: Do you want to output the TIC or BPC of samples? Some times there are a lot of samples, so you can set the `group_for_figure` as the group name, for example, you can set it as `QC`. 

* `min_fraction`: If one peak appears more than `min.fraction` sample in at least one group samples it will be kept.

* `fill_peaks`: Do you want to fill the missing values (NA)? 

Other parameters you can find here: `process_data()`.

---

# **Output results**

---

After all done, all the results are placed in a new folder named as `Result`.

![](figures/Screen-Shot-2022-01-15-at-8.42.04-AM.png)
## `Peak_table.csv`

The peak table for next analysis.

```{r,eval=TRUE, echo=FALSE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
data = readr::read_csv("massprocesser_demo_data/POS/Result/Peak_table.csv")
library(kableExtra)
library(magrittr)
kbl(data[1:500,]) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                fixed_thead = TRUE) %>% 
  scroll_box(width = "100%", height = "600px")
```

> Only top 500 features show.


## `Peak_table_for_cleaning.csv`

Some usefulness columns are deleted from the `Peak_table.csv`, this can be directory used for next data cleaning.

```{r,eval=TRUE, echo=FALSE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
data = readr::read_csv("massprocesser_demo_data/POS/Result/Peak_table_for_cleaning.csv")
library(kableExtra)
library(magrittr)
kbl(data[1:500,]) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                fixed_thead = TRUE) %>% 
  scroll_box(width = "100%", height = "600px")
```

> Only top 500 features show.


## `BPC.pdf` 

Base peak chromatogram

![](figures/Screen-Shot-2022-01-15-at-11.36.11-AM.png)

## `TIC.pdf` 

Total ion peak chromatogram

![](figures/Screen-Shot.png)

## `RT correction plot.pdf`

RT correction.

![](figures/Screen-Shot-1.png)

## `intermediate_data` 

This is a folder which contains some intermediate data. If you want to re-run the data processing, please delete this folder first.

![](figures/Screen-Shot-2022-01-15-at-9.03.43-AM.png)

---

# **Session information**

---

```{r,eval=FALSE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
sessionInfo()
```
